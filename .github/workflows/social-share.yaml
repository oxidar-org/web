name: Share new posts to social media

on:
  workflow_run:
    workflows: ["Deploy Hugo site to Pages"]
    types:
      - completed
    branches:
      - main

  # Allow manual trigger for testing
  workflow_dispatch:

permissions:
  contents: read

defaults:
  run:
    shell: bash

jobs:
  share:
    runs-on: ubuntu-latest
    # Only run if the deploy workflow succeeded (or manual trigger)
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect new posts
        id: detect
        run: |
          NEW_FILES=$(git diff --name-only --diff-filter=A HEAD~1 HEAD -- 'content/posts/' | grep '\.md$' || true)
          # Filter out English translations and index files
          POSTS=$(echo "$NEW_FILES" | grep -v '\.en\.md$' | grep -v '_index\.md' | grep -v '^$' || true)
          if [ -z "$POSTS" ]; then
            echo "No new posts detected."
            echo "has_posts=false" >> "$GITHUB_OUTPUT"
          else
            echo "New posts detected:"
            echo "$POSTS"
            echo "$POSTS" > /tmp/new_posts.txt
            echo "has_posts=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Python
        if: steps.detect.outputs.has_posts == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        if: steps.detect.outputs.has_posts == 'true'
        run: pip install -r scripts/social_share/requirements.txt

      - name: Share to social media
        if: steps.detect.outputs.has_posts == 'true'
        env:
          # AI Provider
          AI_PROVIDER: ${{ vars.AI_PROVIDER || 'anthropic' }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          # Platform toggles
          TWITTER_ENABLED: ${{ vars.TWITTER_ENABLED || 'false' }}
          LINKEDIN_ENABLED: ${{ vars.LINKEDIN_ENABLED || 'false' }}
          BLUESKY_ENABLED: ${{ vars.BLUESKY_ENABLED || 'false' }}
          TELEGRAM_ENABLED: ${{ vars.TELEGRAM_ENABLED || 'false' }}
          # Twitter/X
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
          # LinkedIn
          LINKEDIN_ACCESS_TOKEN: ${{ secrets.LINKEDIN_ACCESS_TOKEN }}
          LINKEDIN_ORG_ID: ${{ secrets.LINKEDIN_ORG_ID }}
          # Bluesky
          BLUESKY_HANDLE: ${{ secrets.BLUESKY_HANDLE }}
          BLUESKY_APP_PASSWORD: ${{ secrets.BLUESKY_APP_PASSWORD }}
          # Telegram
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python scripts/social_share/main.py \
            --posts-file /tmp/new_posts.txt \
            --config .github/social-media-config.yaml
